<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>CS 598</title>
    
    <style>
        html, body {
            background-color: #C1BFC1;
            color: #F8F8F8;
        }
        
        
        #pageContainer {
            background-color: #5D5D5D;
            
            width: 75%;
            min-width: 800px;
            margin: auto;
            padding: 10px;
        }
        
        a {
            color: #AABBFF;
        }
        
        a:visited {
            color: #AADDFF;
        }

        pre {
            background-color: #000000;
            padding: 4px;
        }

        #titleDiv {
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            justify-content: space-between;
            align-items: flex-end;

            width: 100%;
        }
    </style>
</head>
<body>


<div id="pageContainer">

<div id="titleDiv">
    <div>
        <h1>CS 598 - Project</h1>
        <h3><a href="../index.html">William (BJ) Blair</a></h3>
    </div>

    <div>
        <img src="ps1logo.png" width="200" height="200"/>
        <img src="playstation.png" height="100"/>
    </div>
</div>

<hr/>

<h3>Topic</h3>
<p>
Port <a href="http://libsdl.org/">SDL</a> 
(Simple DirectMedia Layer) 1.2 to the SONY Playstation 1
</p>

<h3>Links</h3>
<ul>
<li><a href="http://libsdl.org/">http://libsdl.org/</a> - SDL homepage</li>
<li><a href="http://unhaut.x10host.com/psxsdk/">http://unhaut.x10host.com/psxsdk/</a> - PSX-SDK</li>
<li><a href="http://hitmen.c02.at/html/psx.html">http://hitmen.c02.at/html/psx.html</a> - Hitmen PSX - PSX System Info</li>
<li><a href="http://www.brainycode.com/downloads/LearningSDL011.pdf">http://www.brainycode.com/downloads/LearningSDL011.pdf</a> - In depth SDL tutorial (Good explanation of SDL functions, direct pixel access, etc.)</li>
<li><a href="https://problemkaputt.de/psx-spx.htm">https://problemkaputt.de/psx-spx.htm</a> - Nocash Playstation specs - the holy grail of playstation hardware information :)</li>
</ul>

<h3>Code</h3>
<p>
<a href="https://bitbucket.org/williamblair/psx_sdl/">https://bitbucket.org/williamblair/psx_sdl/</a> <br/>
<a href="https://bitbucket.org/williamblair/psx_sdl_scratch/">https://bitbucket.org/williamblair/psx_sdl_scratch/</a>
</p>

<h3>Setup</h3>

<p>
Ideally, we'd wanna use a hardware debugger setup. Just recently, a user by the name of Lameguy64
released such a thing! However, it requires LiteLoad, a different method uploading from PC to PS1
using the serial port (as opposed to the parallel port of PSIO), so I won't be using it any time soon :(
</p>

<p>
Youtube: <a href="https://www.youtube.com/watch?v=YSgkBlS0oGs">https://www.youtube.com/watch?v=YSgkBlS0oGs</a> <br/>
Github: <a href="https://github.com/Lameguy64/PSn00b-Debugger">https://github.com/Lameguy64/PSn00b-Debugger</a>
</p>

<p>
Instead, I'll mainly be testing on an emulator; <a href="https://problemkaputt.de/psx.htm">NO$PSX</a>,
which has a good amount of debugging utility - however, it doesn't support C line by line debugging
(it does for assembly, though) so it's not perfect. Basically this means I'm stuck with printf
debugging for the most part.
</p>

<p>
Testing on physical hardware will be done through <a href="http://ps-io.com/">PSIO</a>.
You can check out my little page on psio <a href="https://web.cs.sunyit.edu/~blairw/#!/psio">here</a>,
but basically what it does is plug into the parallel port of the playstation and lets you run
games off of an SD card.
</p>

<p>
The reason for using PSIO for hardware testing is that a) you don't have to burn your image to a CD
to run it, and b) you don't even have to copy it to an SD card since you can boot directly off your PC
through a usb cable that plugs into the PSIO!
</p>

<p>
You send the game from the PC to PSIO via the systems console program (Windows only, unfortunately)
</p>
<img src="syscon.png"/>

<h3>Installing PSXSDK</h3>

<p>
Since the PS1 has a MIPS r3000 CPU, a MIPS GCC compiler needs to be installed
first (following the `toolchain.txt` instructions included with PSXSDK source).
</p>

<p>
Installed binutils 2.31, downloaded from 
<a href="https://mirror.clarkson.edu/gnu/binutils/">here</a>.
Configure and install for MIPS with:
</p>
<pre>
./configure --prefix=/usr/local/psxsdk --target=mipsel-unknown-elf --with-float=soft
make
sudo make install
</pre>

<p>
Configure and install gcc 7.2.0, downloaded from 
<a href="http://mirrors-usa.go-parts.com/gcc/releases/">here</a>.
Configure and install with:
</p>
<pre>
mkdir psx_gcc_build && cd psx_gcc_build
/path/to/gcc/configure --disable-libada --disable-libssp --target=mipsel-unknown-elf \
	--prefix=/usr/local/psxsdk --with-float=soft --disable-nls \
	--disable-libstdc++v3 --disable-libstdc__-v3 CFLAGS=-std=c99 \
	--enable-languages=c,c++
make
sudo make install
</pre>

<p>
Finally, install psxsdk, downloaded from <a href="http://unhaut.x10host.com/psxsdk/">
here</a>, release 20180115. First, edit <pre>Makefile.cfg</pre> to
set the proper `make`, `toolchain_prefix`, and `examples_vmode`. Examples
vmode sets whether to initialize video for a PAL or NTSC playstation.
toolchain_prefix is where to install psxsdk, and 'make' is the make
executable to use (e.g. 'make', 'gmake', 'mingw32-make', etc.).
Configure and install with:
</p>

<pre>
export PATH=$PATH:/path/to/psxsdkdir
make
sudo make install
</pre>

<p>
You should then add `export PATH=$PATH:/path/to/psxsdk` to your 
bashrc or profile. Then you should be able to run `psx-gcc -v` and
it should output something similar to this:
<p>

<pre>
Using built-in specs.
COLLECT_GCC=mipsel-unknown-elf-gcc
COLLECT_LTO_WRAPPER=/usr/local/psxsdk/libexec/gcc/mipsel-unknown-elf/7.2.0/lto-wrapper
Target: mipsel-unknown-elf
Configured with: /home/bj/gcc-7.2.0/configure --disable-libada --disable-libssp --target=mipsel-unknown-elf --prefix=/usr/local/psxsdk --with-float=soft --disable-nls --disable-libstdc++v3 --disable-libstdc__-v3 CFLAGS=-std=c99 --enable-languages=c,c++
Thread model: single
gcc version 7.2.0 (GCC) 
</pre>

<p>
Since PSIO is windows only, all of this was done in a virtual machine
running Arch Linux, with shared folders configured, so we can compile
on linux and still run/access the code through windows.
</p>

<h3>Programming with psxsdk</h3>

<p>
You can find examples for psxsdk contained in the source archive,
plus more <a href="https://github.com/ColdSauce/psxsdk/tree/master/examples">here</a>.
</p>

<p>
Here's a hello world example:
</p>

<pre>
<code>#include &lt;psx.h&gt;
#include &lt;stdio.h&gt;

unsigned int prim_list[0x4000];

volatile int display_is_old = 1;
volatile int time_counter = 0;
int  dbuf=0;

void prog_vblank_handler() {
    display_is_old = 1;
    time_counter++;
}

int main() {
    PSX_Init();                                 // Initialize the PSX
    GsInit();                                   // Initialize Graphics
    GsSetList(prim_list);                       // Tells the graphics system what memory to use to order primitives (zbuffering)
    GsClearMem();
    GsSetVideoMode(320, 240, EXAMPLES_VMODE);   // either VMODE_PAL or VMODE_NTSC
    GsLoadFont(768, 0, 768, 256);               // Load the PSX bios font into VRAM memory
    SetVBlankHandler(prog_vblank_handler);      // calls `prog_vblank_handler()` on vblanks

    while(1) {

        /* don't try to draw unless the screen is ready to redraw */
        if(display_is_old)    {

            /* switch display and draw locations to create double buffering */
            dbuf=!dbuf;
            GsSetDispEnvSimple(0, dbuf ? 0 : 256);
            GsSetDrawEnvSimple(0, dbuf ? 256 : 0, 320, 240);

            GsSortCls(0,0,0);

            GsPrintFont(70, 120, "Hello world from PSX");
    
            /* draw primitives with order based on prim_list */
            GsDrawList();

            /* Wait for the GPU to finish */
            while(GsIsDrawing());

            display_is_old=0;
        }
    }

    return 0;
}</code>
</pre>

<p>
Here's the helloworld example running on the playstation via PSIO:
</p>
<img src="psio_helloworld.jpg" width="400px"/>

<p>
And here's the helloworld example running in the NO$PSX emulator:
</p>

<img src="nopsx_helloworld.png" width="600px"/>

<h3>About the Playstation 1</h3>

<p>
Specs: (Information from <a href="https://en.wikipedia.org/wiki/PlayStation_technical_specifications">Wikipedia</a>)

<ul>
    <li>Modified MIPS R3000A 32-bit RISC CPU, runs at 33.8688 MHz</li>
    <li>Geometry Transformation Engine (GTE)
        <ul>
            <li>Coprocessor inside the CPU</li>
            <li>Handles Vector Math for 3D Graphics</li>
            <li>High Speed Matrix Multiplications</li>
            <li>66 MIPS (Millions of Instructions per Second)</li>
            <li>Rendered Polygons per Second
                <ul>
                    <li>90,000 with texture mapping/lighting/Gouraud Shading</li>
                    <li>180,000 with texture mapping</li>
                    <li>360,000 with flat shading</li>
                </ul>
            </li>
        </ul>
    </li>
    <li>2MB RAM</li>
    <li>BIOS ROM stored in 512kb</li>
    <li>32-bit SONY Gpu
        <ul>
            <li>1MB VRAM (1024x512 at 16 bits framebuffer)</li>
            <li>2KB texture cache</li>
            <li>Resolutions: 256x224..640x240 progessive, 256x448..640x480 interlaced</li>
            <li>4bit, 8bit, 15bit, or 24bit color</li>
            <li>Maximum 4,000 sprites on screen (at 8x8 size), 256x256 maximum sprite size</li>
        </ul>
    </li>
</ul>
</p>

<h3>Playstation VRAM</h3>

<p>
Below is a visual representation of the PSX's VRAM from a sprite creation utility called TIM Tool.
(TIM is the image format normally used by the playstation.) The VRAM is divided into 32 
texture pages of size 64x256px. The max width of a sprite texture is 256x256px, or 4 texture pages wide. 
</p>
<ul>
   <li>The far left of the VRAM is what is actually displayed on the T.V., and is split into a top and
bottom half for double buffering.
   </li>
   <li>The top right is normally used to store texture data</li>
   <li>The bottom right is normally used to store CLUTs (Color Lookup Tables) for 8bit and 4bit 
       display modes.
   </li>
</ul>

<img src="timtool2.png" width="800"/><br/>
Base image courtesy of <a href="http://onorisoft.free.fr/retro.htm">Orion's PSX Page</a>

<p>As you can see on the far left, the standard display buffer takes up 5 texture pages,
   or 320x256px. This is the normal resolution used by most games for the playstation.
</p>

<p>
The frame buffer is NOT directly accessible through memory (no dma); instead you have to send
commands to the GPU, through registers GP0 and GP1.
</p>

</div> <!-- end pageContainer id -->

</body>
</html>




